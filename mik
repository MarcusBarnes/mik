#!/usr/bin/env php
<?php
// mik.php
/**
 * Main Move to Islandora Kit script.
 **/

// Use composer to load vendor and project classes.
require 'vendor/autoload.php';

use mik\config\Config;
use League\CLImate\CLImate;

// Get command line options.
// Assumes --longopts.
// Required --config=path/to/config/ini_file
// Optional --limit=10 (where 10 is the number of input objects to process; if not set, processes all objects)
//          --checkconfig=type (where type is one of 'snippets', 'urls', 'paths', or 'all'; just apply checks to configuration, do not process objects)
$options = getopt('', array('config:', 'limit::', 'checkconfig::'));

$configPath = $options['config'];
if (!file_exists($options['config'])) {
    exit("Sorry, can't find " . $options['config'] . "\n");
}

if (isset($options['limit'])) {
    $limit = $options['limit'];
}
else {
    $limit = null;
}

// Instantiate a configuration.
$mikConfig = new Config($configPath);
$settings = $mikConfig->settings;
if (isset($options['checkconfig'])) {
    $mikConfig->validate($options['checkconfig']);
}

// Fetch metadata records.
$fetcherClass = 'mik\\fetchers\\' . $settings['FETCHER']['class'];
$fetcher = new $fetcherClass($settings);
$numRecs = $fetcher->getNumRecs();

// Instantiate the "ingest" progress bar.
$climate = new League\CLImate\CLImate;
$progress = $climate->progress()->total($numRecs);

// Instantiate fileGetter class.
$fileGetterClass = 'mik\\filegetters\\' . $settings['FILE_GETTER']['class'];
$fileGetter = new $fileGetterClass($settings);

// Create Islandora ingest packages.
$records = $fetcher->getRecords($limit);
$numFilteredRecs = count($records);
echo "Creating $numRecs Islandora ingest packages. Please be patient.\n";
$record_num = 0;
foreach ($records as $record) {
      $record_key = $record->key;
      if (strlen($record_key) == 0) {
          continue;
      }

      // The metadata parser returns an XML file that can be passed on to
      // the metadata manipulater.
      $metadtaClass = 'mik\\metadataparsers\\' . $settings['METADATA_PARSER']['class'];
      $parser = new $metadtaClass($settings);
      $metadata = $parser->metadata($record_key) . "\n";

      $children = $fileGetter->getChildren($record_key);

      // The writer writes metadata XML files and associated content files (files retrieved,
      // modfied, or generated by the file getters and manipulaters) to their output location.
      $writerClass = 'mik\\writers\\' . $settings['WRITER']['class'];
      $writer = new $writerClass($settings);
      $writer->writePackages($metadata, $children, $record_key);

      $record_num++;  
      $progress->current($record_num);
}

echo "Done. Output packages are in " . $settings['WRITER']['output_directory'] .
    ". Log is at "  . $settings['LOGGING']['path_to_log'] . "\n";